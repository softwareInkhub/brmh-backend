name: Deploy to AWS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Deploy to AWS
      uses: appleboy/ssh-action@master
      with:
        host: ec2-34-238-24-134.compute-1.amazonaws.com
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # === COMPREHENSIVE CLEANUP AND DISK SPACE MANAGEMENT ===
          echo "ðŸ§¹ Starting comprehensive cleanup..."
          
          # System cleanup
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo rm -rf /var/cache/apt/archives/*
          sudo rm -rf /tmp/*
          sudo rm -rf /var/tmp/*
          
          # Clean Docker if installed
          if command -v docker &> /dev/null; then
            echo "ðŸ³ Cleaning Docker..."
            sudo docker system prune -f || true
          fi
          
          # Clean journal logs
          echo "ðŸ“‹ Cleaning system logs..."
          sudo journalctl --vacuum-size=50M || true
          sudo journalctl --vacuum-time=7d || true
          
          # Check initial disk space
          echo "ðŸ“Š Initial disk space:"
          df -h
          
          # Navigate to project directory
          cd /home/ubuntu/brmh-backend
          
          # === PM2 LOGS CLEANUP ===
          echo "ðŸ—‚ï¸ Cleaning PM2 logs..."
          pm2 flush || true
          
          # Clean PM2 log directory
          if [ -d "$HOME/.pm2/logs" ]; then
            echo "ðŸ—‚ï¸ Removing old PM2 logs..."
            sudo rm -rf $HOME/.pm2/logs/*
          fi
          
          # === NPM AND NODE CLEANUP ===
          echo "ðŸ§¹ Deep cleaning npm and node..."
          
          # Stop existing PM2 processes first
          pm2 stop all || true
          pm2 delete all || true
          
          # Clean npm cache aggressively
          npm cache clean --force
          npm cache verify
          
          # Remove any corrupted npm cache
          rm -rf ~/.npm/_cacache
          rm -rf ~/.npm/_logs
          rm -rf ~/.npm/_npx
          
          # Remove node_modules only (keep package-lock.json for npm ci)
          rm -rf node_modules
          
          # Clean global npm cache
          sudo npm cache clean --force
          
          # Clear any npm temporary files
          rm -rf ~/.npm/_cacache
          rm -rf ~/.npm/_logs
          
          # === GIT OPERATIONS ===
          echo "ðŸ“¦ Updating code..."
          git clean -fd
          git reset --hard HEAD
          git pull origin main
          
          # === DEPENDENCY INSTALLATION ===
          echo "ðŸ“¦ Installing dependencies with optimizations..."
          
          # Check disk space before installation
          echo "ðŸ“Š Disk space before npm install:"
          df -h
          
          # Check available space
          available_space=$(df / | awk 'NR==2 {print $4}')
          echo "ðŸ“Š Available space: ${available_space}KB"
          
          # Always use npm install to ensure lock file is in sync
          echo "ðŸ“¦ Using npm install to ensure package-lock.json is in sync"
          echo "ðŸ“Š Package.json exists: $([ -f "package.json" ] && echo "Yes" || echo "No")"
          echo "ðŸ“Š Package-lock.json exists: $([ -f "package-lock.json" ] && echo "Yes" || echo "No")"
          
          # Install dependencies with production flag
          echo "ðŸ”„ Attempting npm install..."
          NODE_ENV=production npm install --omit=dev --omit=optional --no-audit --no-fund
          
          # Verify installation
          if [ $? -eq 0 ]; then
            echo "âœ… Dependencies installed successfully"
          else
            echo "âŒ First npm install failed, trying fallback..."
            
            # Fallback: Remove lock file and try again
            echo "ðŸ”„ Removing package-lock.json and retrying..."
            rm -f package-lock.json
            NODE_ENV=production npm install --omit=dev --omit=optional --no-audit --no-fund
            
            if [ $? -eq 0 ]; then
              echo "âœ… Dependencies installed successfully on retry"
            else
              echo "âŒ Dependency installation failed completely"
              echo "ðŸ“Š Final disk space:"
              df -h
              echo "ðŸ“Š npm debug log:"
              cat ~/.npm/_logs/*.log | tail -20 || echo "No npm logs found"
              exit 1
            fi
          fi
          
          # === PM2 SETUP WITH LOG ROTATION ===
          echo "ðŸš€ Setting up PM2 with log rotation..."
          
          # Install PM2 globally if not exists
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2 --unsafe-perm
          fi
          
          # Remove PM2 logrotate completely to prevent infinite loops
          pm2 delete pm2-logrotate || true
          pm2 uninstall pm2-logrotate || true
          
          # Clean up any existing logrotate configuration
          rm -rf ~/.pm2/module_conf.json || true
          
          # We'll rely on system logrotate instead of PM2 logrotate
          echo "PM2 logrotate disabled - using system logrotate only"
          
          # Create PM2 ecosystem file with log limits (CommonJS for PM2)
          cat > ecosystem.config.cjs << 'EOF'
          module.exports = {
            apps: [{
              name: 'brmh-backend-v2',
              script: 'npm',
              args: 'start',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '2G',
              env: {
                NODE_ENV: 'production',
                PORT: 5001
              },
              log_file: '/home/ubuntu/.pm2/logs/brmh-backend-v2.log',
              out_file: '/home/ubuntu/.pm2/logs/brmh-backend-v2-out.log',
              error_file: '/home/ubuntu/.pm2/logs/brmh-backend-v2-error.log',
              log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              merge_logs: true,
              max_restarts: 10,
              min_uptime: '10s'
            }]
          };
          EOF
          
          # === APPLICATION STARTUP ===
          echo "ðŸš€ Starting application with ecosystem config..."
          pm2 start ecosystem.config.cjs
          
          # Save PM2 configuration after successful start
          pm2 save --force
          
          # === SYSTEM SERVICE SETUP ===
          echo "âš™ï¸ Setting up PM2 startup script..."
          sudo pm2 unstartup systemd || true
          sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
          
          # Reload systemd daemon
          sudo systemctl daemon-reload
          
          # Enable and start the PM2 service
          sudo systemctl enable pm2-ubuntu
          sudo systemctl start pm2-ubuntu
          
          # === SETUP SYSTEM LOG ROTATION ===
          echo "âš™ï¸ Setting up system log rotation..."
          sudo tee /etc/logrotate.d/pm2-ubuntu << 'EOF'
          /home/ubuntu/.pm2/logs/*.log {
              daily
              missingok
              rotate 3
              compress
              notifempty
              create 0640 ubuntu ubuntu
              size 50M
              delaycompress
              copytruncate
              postrotate
                  pm2 reloadLogs || true
              endscript
          }
          EOF
          
          # === SETUP CLEANUP CRON JOB ===
          echo "â° Setting up automated cleanup..."
          (crontab -l 2>/dev/null || true; echo "0 2 * * * /usr/bin/find /home/ubuntu/.pm2/logs -name '*.log' -size +50M -delete") | crontab -
          (crontab -l 2>/dev/null || true; echo "0 3 * * * /usr/bin/pm2 flush") | crontab -
          (crontab -l 2>/dev/null || true; echo "0 4 * * 0 /usr/bin/npm cache clean --force") | crontab -
          
          # === VERIFICATION ===
          echo "âœ… Verifying deployment..."
          
          # Check PM2 status
          pm2 status
          
          # Check log rotation configuration
          pm2 conf pm2-logrotate
          
          # Verify service status
          sudo systemctl status pm2-ubuntu --no-pager
          
          # Check log file sizes
          echo "ðŸ“Š Current log file sizes:"
          find /home/ubuntu/.pm2/logs -name "*.log" -exec ls -lh {} \; 2>/dev/null || echo "No log files found yet"
          
          # Final disk space check
          echo "ðŸ“Š Final disk space:"
          df -h
          
          echo "ðŸŽ‰ Deployment completed with log management!"